import { writable, derived, type Readable } from 'svelte/store';

export type Lang = 'zh-CN' | 'en';

const messages = {
  'zh-CN': {
    'app.title': 'AI 公式扫描器',
    'nav.recognition': '公式识别',
    'nav.history': '历史记录',
    'nav.favorites': '收藏夹',
    'nav.settings': '设置',

    'settings.title': '设置',
    'settings.subtitle': '配置你的应用偏好',
    'settings.language.desc': '配置通用偏好（例如：界面语言）。',
    'settings.general.title': '通用配置',
    'settings.language': '界面语言',
    'settings.language.zh': '中文（简体）',
    'settings.language.en': '英语',
    'settings.shortcut.title': '快捷键设置',
    'settings.shortcut.screenshot': '截图识别快捷键',
    'settings.shortcut.recording': '请按下快捷键组合...',
    'settings.shortcut.modify': '修改',

    'settings.display': '显示配置',
    'settings.display.subtitle': '调整公式与内容的展示方式。',
    'settings.display.engine.mathjax': 'MathJax（推荐）',
    'settings.display.engine.katex': 'KaTeX',
    'settings.window.title': '窗口设置',
    'settings.window.subtitle': '设置默认窗口大小，或记住上次窗口尺寸与位置。',
    'settings.window.width': '窗口宽度',
    'settings.window.height': '窗口高度',
    'settings.window.remember': '记住上次窗口尺寸与位置',
    'settings.window.apply_now': '应用到当前窗口',

    // Settings - AI & API
    'settings.ai.title': 'AI 配置',
    'settings.ai.desc': '管理 API 和提示词配置。',
      'settings.api.title': 'API 配置',
      'settings.api.provider': '服务提供商（目前只支持Google）',
    'settings.api.key': 'API 密钥',
    'settings.api.key.ph': '请输入你的 API 密钥',
    'settings.api.base_url': 'API 基础 URL',
    'settings.api.base_url.ph': '例如：https://generativelanguage.googleapis.com/v1beta/models',
    'settings.api.model': '模型',
    'settings.api.model.ph': '例如：gemini-2.5-pro',
    'settings.actions.test': '测试',
    'settings.actions.testing': '测试中...',
    'settings.actions.save': '保存',
    'settings.actions.open_config_dir': '打开配置目录',
    'settings.prompt.title': '提示词配置',
    'settings.prompt.latex_label': 'LaTeX 提示词（仅输出 LaTeX）',
    'settings.prompt.analysis_label': '分析提示词（标题/简介/变量/项/建议）',
    'settings.prompt.verification_label': '核查提示词',
    'settings.prompt.custom': '自定义提示词',
    'settings.prompt.custom.ph': '输入用于公式识别的自定义提示词',
    'settings.prompt.confidence': '置信度提示词',
    'settings.prompt.confidence.ph': '输入用于置信度评估的提示词',
    'settings.prompt.reset': '恢复默认提示词',
    'settings.prompt.reset_ok': '已恢复默认提示词',
    'settings.display.render_engine': '渲染引擎',
    'settings.display.latex_format': 'LaTeX 格式',
    'settings.display.format.raw': '原始（默认）',
    'settings.display.format.single': '单美元 ($...$)',
    'settings.display.format.double': '双美元 ($$...$$)',
    'settings.display.format.equation': '公式环境',
    'settings.display.format.bracket': '中括号 (\\[...\\])',
    'settings.advanced.title': '高级配置',
    'settings.advanced.desc': '配置超时、重试等高级功能。',
    'settings.advanced.timeout': '请求超时（秒）',
    'settings.advanced.retries': '最大重试次数',
    'settings.advanced.max_output_tokens': '最大输出 Token',
    'settings.advanced.auto_conf': '自动计算置信度（未实装）',
    'settings.advanced.clipboard': '启用剪贴板监听',
    'settings.advanced.clipboard_pending': '启用剪贴板监听（未实装）',
    'settings.advanced.clipboard_hint': '暂未实现后台监听逻辑',
    'settings.alert.save_success': '配置已保存成功！',
    'settings.alert.save_failed': '保存配置失败，请重试。',
    'settings.alert.shortcut_failed': '快捷键注册失败',
    'settings.alert.key_required': '请先输入 API 密钥。',
    'settings.alert.test_success': '连接测试成功！',
    'settings.alert.test_failed': '连接测试失败，请检查配置。',
    'settings.alert.test_failed_code': '连接测试失败（代码 {code}）',

    // About section
    'about.title': '关于',
    'about.app_name': 'AI 公式扫描器',
    'about.version': '版本 0.2.0',
    'about.description': '基于 AI 的公式 OCR 识别、分析和管理软件。',
    'about.tech_stack': '技术栈',

    // Main page
    'main.title': '公式识别',
    'main.subtitle': '上传图片或拖拽文件到此处开始识别数学公式',
    'main.upload.button': '选择文件',
    'main.upload.drag': '或拖拽文件到此处',
    'main.upload.formats': '支持 PNG、JPG、JPEG、GIF、BMP、WEBP 格式',
    'main.result.title': '识别结果',
    'main.result.confidence': '置信度',
    'main.result.latex': 'LaTeX 代码',
    'main.result.preview': '预览',
    'main.result.copy': '复制',
    'main.result.save': '保存到收藏夹',
    'main.result.analysis': '分析',
    'main.result.suggestions': '建议',
    'main.result.variables': '变量',
    'main.result.terms': '术语',
    'main.result.unit': '单位',
    'main.result.verification_report': '验证报告（beta）',

    // Recognition view
    'recognition.region_capture': '截图识别',
    'recognition.import': '导入图片',
    'recognition.processing': '处理中...',
    'recognition.loading': '正在处理，请稍候...',
    'recognition.error.config_missing': '请先在设置中配置API密钥',
    'recognition.error.failed': '识别失败',
    'recognition.error.failed_code': '识别失败（代码 {code}）',
    'recognition.file.error_failed': '文件识别失败',
    'recognition.file.error_failed_code': '文件识别失败（代码 {code}）',
    'recognition.error.finish_reason': '识别中断（原因: {reason}）',
    'recognition.finish_reason.stop': '模型结束但未返回文本，请重试或更换模型/降低提示复杂度',
    'recognition.finish_reason.max_tokens': '达到最大输出长度，请增大“最大输出 Token”或更换支持更长输出的模型',
    'recognition.copy_latex': '复制LaTeX',
    'recognition.copy_latex_success': 'LaTeX已复制到剪贴板',
    'recognition.copy_latex_failed': '复制LaTeX失败',
    'recognition.copy_image': '复制图片',
    'recognition.copy_image_success': '图片已复制到剪贴板',
    'recognition.copy_image_failed': '复制图片失败',
    'recognition.save_history': '保存到历史',
    'recognition.save_history_success': '已保存到历史记录',
    'recognition.save_history_failed': '保存到历史失败',
    'recognition.analysis': '智能分析',
    'recognition.suggestions': '建议',
    'analysis.variables': '变量',
    'analysis.terms': '术语',
    'analysis.suggestions': '建议',
    'analysis.unit': '单位',
    'recognition.confidence': '置信度',
    // 'recognition.confidence_check': 'AI置信度校验', // 已移除按钮
    // 'recognition.confidence_checking': '校验中...', // 已移除按钮
    'recognition.confidence_error': '获取置信度失败',
    'recognition.verification': '核查结果',
    'recognition.verification_status': '状态',
    'recognition.start_hint': '请使用上方的按钮开始识别公式',
    'recognition.image_alt': '原始公式图片',
    'recognition.original_image': '原始图片',
    'recognition.view_suggestions': '查看建议',
    'recognition.latex_code': 'LaTeX 代码',
    'recognition.tab.basic': '基础',
    'recognition.tab.analysis': '分析',

    // Favorites & History
    'favorites.title': '收藏夹',
    'favorites.loading': '正在加载收藏夹...',
    'favorites.empty': '收藏夹为空',
    'favorites.no_results': '没有找到匹配的结果',
    'favorites.search_placeholder': '搜索公式标题或LaTeX内容...',
    'favorites.view_details': '查看详情',
    'favorites.load_failed': '加载收藏夹失败',
    'favorites.update_failed': '更新收藏状态失败',

    'history.title': '历史记录',
    'history.loading': '正在加载历史记录...',
    'history.empty': '历史记录为空',
    'history.no_results': '没有找到匹配的结果',
    'history.search_placeholder': '搜索公式标题或LaTeX内容...',
    'history.view_details': '查看详情',
    'history.sort.date_desc': '按时间（新→旧）',
    'history.sort.date_asc': '按时间（旧→新）',
    'history.sort.title_asc': '按名称（A→Z）',
    'history.sort.title_desc': '按名称（Z→A）',
    'history.delete': '删除',
    'history.load_failed': '加载历史记录失败',
    'history.update_failed': '更新收藏状态失败',

    // Common
    'common.close': '关闭',
    'common.cancel': '取消',
    'common.favorite.add': '添加到收藏',
    'common.favorite.remove': '取消收藏',
    'formulas.placeholder': '公式将在这里显示',
    'editor.placeholder': '在此输入或编辑LaTeX代码...',
    'formulas.render_error': '渲染错误'
  },
  en: {
    'app.title': 'AI Formula Scanner',
    'nav.recognition': 'Recognition',
    'nav.history': 'History',
    'nav.favorites': 'Favorites',
    'nav.settings': 'Settings',

    'settings.title': 'Settings',
    'settings.subtitle': 'Configure your application preferences',
    'settings.language.desc': 'Configure general preferences (e.g., interface language).',
    'settings.general.title': 'General',
    'settings.language': 'Interface Language',
    'settings.language.zh': 'Chinese (Simplified)',
    'settings.language.en': 'English',
    'settings.shortcut.title': 'Shortcut Settings',
    'settings.shortcut.screenshot': 'Screenshot Recognition Shortcut',
    'settings.shortcut.recording': 'Press shortcut combination...',
    'settings.shortcut.modify': 'Modify',

    'settings.display': 'Display Configuration',
    'settings.display.subtitle': 'Adjust how formulas and content are displayed.',
    'settings.window.title': 'Window',
    'settings.window.subtitle': 'Set default window size, or remember last size & position.',
    'settings.window.width': 'Width',
    'settings.window.height': 'Height',
    'settings.window.remember': 'Remember last size & position',
    'settings.window.apply_now': 'Apply to current window',

    // Settings - AI & API
    'settings.ai.title': 'AI Configuration',
    'settings.ai.desc': 'Manage API settings and prompt configurations.',
      'settings.api.title': 'API Configuration',
      'settings.api.provider': 'Provider (Google only for now)',
    'settings.api.key': 'API Key',
    'settings.api.key.ph': 'Enter your API key',
    'settings.api.base_url': 'API Base URL',
    'settings.api.base_url.ph': 'e.g., https://generativelanguage.googleapis.com/v1beta/models',
    'settings.api.model': 'Model',
    'settings.api.model.ph': 'e.g., gemini-2.5-pro',
    'settings.actions.test': 'Test',
    'settings.actions.testing': 'Testing...',
    'settings.actions.save': 'Save',
    'settings.actions.open_config_dir': 'Open Config Folder',
    'settings.prompt.title': 'Prompt Configuration',
    'settings.prompt.latex_label': 'LaTeX Prompt (LaTeX only)',
    'settings.prompt.analysis_label': 'Analysis Prompt (title/summary/variables/terms/suggestions)',
    'settings.prompt.verification_label': 'Verification Prompt',
    'settings.prompt.custom': 'Custom Prompt',
    'settings.prompt.custom.ph': 'Enter your custom prompt for formula recognition',
    'settings.prompt.confidence': 'Confidence Prompt',
    'settings.prompt.confidence.ph': 'Enter your prompt for confidence evaluation',
    'settings.prompt.reset': 'Reset to defaults',
    'settings.prompt.reset_ok': 'Prompts restored to defaults',
    'settings.display.render_engine': 'Render Engine',
    'settings.display.engine.mathjax': 'MathJax (recommended)',
    'settings.display.engine.katex': 'KaTeX',
    'settings.display.latex_format': 'LaTeX Format',
    'settings.display.format.raw': 'Raw (default)',
    'settings.display.format.single': 'Single Dollar ($...$)',
    'settings.display.format.double': 'Double Dollar ($$...$$)',
    'settings.display.format.equation': 'Equation Environment',
    'settings.display.format.bracket': 'Bracket (\\[...\\])',
    'settings.advanced.title': 'Advanced Configuration',
    'settings.advanced.desc': 'Configure timeouts, retries, and other advanced features.',
    'settings.advanced.timeout': 'Request Timeout (seconds)',
    'settings.advanced.retries': 'Max Retries',
    'settings.advanced.max_output_tokens': 'Max Output Tokens',
    'settings.advanced.auto_conf': 'Auto Calculate Confidence (not implemented yet)',
    'settings.advanced.clipboard': 'Enable Clipboard Watcher',
    'settings.advanced.clipboard_pending': 'Enable Clipboard Watcher (not implemented yet)',
    'settings.advanced.clipboard_hint': 'Background clipboard watcher not implemented yet',
    'settings.alert.save_success': 'Configuration saved successfully!',
    'settings.alert.save_failed': 'Failed to save configuration. Please try again.',
    'settings.alert.shortcut_failed': 'Failed to register shortcut',
    'settings.alert.key_required': 'Please enter an API key first.',
    'settings.alert.test_success': 'Connection test succeeded!',
    'settings.alert.test_failed': 'Connection test failed. Please check your configuration.',
    'settings.alert.test_failed_code': 'Connection test failed (code {code})',

    // About section
    'about.title': 'About',
    'about.app_name': 'AI Formula Scanner',
    'about.version': 'Version 0.2.0',
    'about.description': 'AI-powered formula OCR recognition, analysis and management software.',
    'about.tech_stack': 'Tech Stack',

    // Main page
    'main.title': 'Formula Recognition',
    'main.subtitle': 'Upload an image or drag files here to start recognizing mathematical formulas',
    'main.upload.button': 'Choose File',
    'main.upload.drag': 'or drag files here',
    'main.upload.formats': 'Supports PNG, JPG, JPEG, GIF, BMP, WEBP formats',
    'main.result.title': 'Recognition Result',
    'main.result.confidence': 'Confidence',
    'main.result.latex': 'LaTeX Code',
    'main.result.preview': 'Preview',
    'main.result.copy': 'Copy',
    'main.result.save': 'Save to Favorites',
    'main.result.analysis': 'Analysis',
    'main.result.suggestions': 'Suggestions',
    'main.result.variables': 'Variables',
    'main.result.terms': 'Terms',
    'main.result.unit': 'Unit',
    'main.result.verification_report': 'Verification Report (beta)',

    // Recognition view
    'recognition.region_capture': 'Screenshot Recognition',
    'recognition.import': 'Import Image',
    'recognition.processing': 'Processing...',
    'recognition.loading': 'Processing, please wait...',
    'recognition.error.config_missing': 'Please configure API key in Settings first',
    'recognition.error.failed': 'Recognition failed',
    'recognition.error.failed_code': 'Recognition failed (code {code})',
    'recognition.file.error_failed': 'File recognition failed',
    'recognition.file.error_failed_code': 'File recognition failed (code {code})',
    'recognition.error.finish_reason': 'Recognition interrupted (reason: {reason})',
    'recognition.finish_reason.stop': 'Model stopped without returning text. Please retry, switch model, or simplify the prompt',
    'recognition.finish_reason.max_tokens': 'Reached maximum output length. Increase Max Output Tokens or use a model with higher output limits',
    'recognition.copy_latex': 'Copy LaTeX',
    'recognition.copy_latex_success': 'LaTeX copied to clipboard',
    'recognition.copy_latex_failed': 'Failed to copy LaTeX',
    'recognition.copy_image': 'Copy Image',
    'recognition.copy_image_success': 'Image copied to clipboard',
    'recognition.copy_image_failed': 'Failed to copy image',
    'recognition.save_history': 'Save to History',
    'recognition.save_history_success': 'Saved to history',
    'recognition.save_history_failed': 'Failed to save to history',
    'recognition.analysis': 'Smart Analysis',
    'recognition.suggestions': 'Suggestions',
    'analysis.variables': 'Variables',
    'analysis.terms': 'Terms',
    'analysis.suggestions': 'Suggestions',
    'analysis.unit': 'Unit',
    'recognition.confidence': 'Confidence',
    // 'recognition.confidence_check': 'AI Confidence Check', // 已移除按钮
    // 'recognition.confidence_checking': 'Checking...', // 已移除按钮
    'recognition.confidence_error': 'Failed to get confidence score',
    'recognition.verification': 'Verification',
    'recognition.verification_status': 'Status',
    'recognition.start_hint': 'Use the buttons above to start recognizing formulas',
    'recognition.image_alt': 'Original formula image',
    'recognition.original_image': 'Original Image',
    'recognition.view_suggestions': 'View suggestions',
    'recognition.latex_code': 'LaTeX Code',
    'recognition.tab.basic': 'Basic',
    'recognition.tab.analysis': 'Analysis',

    // Favorites & History
    'favorites.title': 'Favorites',
    'favorites.loading': 'Loading favorites...',
    'favorites.empty': 'Favorites is empty',
    'favorites.no_results': 'No matching results found',
    'favorites.search_placeholder': 'Search by title or LaTeX...',
    'favorites.view_details': 'View details',
    'favorites.load_failed': 'Failed to load favorites',
    'favorites.update_failed': 'Failed to update favorite status',

    'history.title': 'History',
    'history.loading': 'Loading history...',
    'history.empty': 'History is empty',
    'history.no_results': 'No matching results found',
    'history.search_placeholder': 'Search by title or LaTeX...',
    'history.view_details': 'View Details',
    'history.sort.date_desc': 'By Time (new → old)',
    'history.sort.date_asc': 'By Time (old → new)',
    'history.sort.title_asc': 'By Title (A → Z)',
    'history.sort.title_desc': 'By Title (Z → A)',
    'history.delete': 'Delete',
    'history.load_failed': 'Failed to load history',
    'history.update_failed': 'Failed to update favorite status',

    // Common
    'common.close': 'Close',
    'common.cancel': 'Cancel',
    'common.favorite.add': 'Add to Favorites',
    'common.favorite.remove': 'Remove from Favorites',
    'formulas.placeholder': 'Formula will be shown here',
    'editor.placeholder': 'Type or edit LaTeX code here...',
    'formulas.render_error': 'Render error'
  }
} as const;

const langStore = writable<Lang>('en');
export const currentLang: Readable<Lang> = langStore;

export function setLanguage(lang: Lang) {
  langStore.set(lang);
  if (typeof document !== 'undefined') {
    document.documentElement.setAttribute('lang', lang);
  }
}

export function t(key: keyof typeof messages['en'] | string): Readable<string> {
  return derived(langStore, ($lang) => {
    const dict = (messages as any)[$lang] ?? messages['en'];
    return (dict[key] ?? (messages['en'] as any)[key] ?? key) as string;
  });
}

export function translateNow(key: string, lang?: Lang): string {
  const l = lang ?? 'en';
  const dict = (messages as any)[l] ?? messages['en'];
  return (dict[key] ?? (messages['en'] as any)[key] ?? key) as string;
}

